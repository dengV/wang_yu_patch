
var md5 = require('md5');
var async = require('async');
var path = require('path');

function PatchDigestPlugin () {

}

PatchDigestPlugin.prototype.apply = function (compiler) {
    var outputPath = compiler.options.output.path; //获取输出路径
    var outPutFileSystem = compiler.outputFileSystem; //获取输出文件的sysytem
    compiler.plugin("after-emit",function (compilation,callback) {
      // 遍历assets
       async.forEach(Object.keys(compilation.assets),function (file, callback) {
           var targetFile = file;
           var queryStringIdx = targetFile.indexOf("?");
           if(queryStringIdx >= 0) {
               targetFile = targetFile.substr(0, queryStringIdx);
           }
          if(path.extname(targetFile) == '.js') {
               // 如果输出的文件是js
            var digestFilePath = path.resolve(outputPath, path.dirname(targetFile),path.basename(targetFile,'.js')+'.md5');
            var source = compilation.assets[file];
            var content = source.source(); //获取到source 的内容
              if(!Buffer.isBuffer(content)) {
                  content = new Buffer(content, "utf8"); //eslint-disable-line
              }
              var digest = md5(content);
              outPutFileSystem.writeFile(digestFilePath,digest);
          }
       })

        callback();
    })
}


module.exports = PatchDigestPlugin;

